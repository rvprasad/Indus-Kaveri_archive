<?xml version="1.0" encoding="iso-8859-1"?>
<!-- $Revision$ -->

<project name="indus" default="dist" basedir=".">
    <tstamp/>

	<property file="distbuild.properties" />
	
    <path id="subprojects.buildfiles">
        <pathelement path="${projects.dir}/Indus"/>
        <pathelement path="${projects.dir}/StaticAnalyses"/>
        <pathelement path="${projects.dir}/JavaSlicer"/>
    </path>

    <target name="init">
        <tstamp/>
    	<delete dir="${projects.dir}"/>
    	<mkdir dir="${projects.dir}"/>
        <cvs cvsroot="${cvs.root}"
            compression="true" compressionlevel="3"
            package="${cvs.modules}"
            cvsRsh="ssh"
            dest="${projects.dir}" failonerror="true"
            command="co"/>
    </target>

    <target name="dist" depends="init, cleanAll, buildAllCode, buildAllDoc">
		<antcall target="package"/>
    	<delete dir="${projects.dir}"/>
	</target>
	
	<target name="package">
        <mkdir dir="${dist.ug.dir}"/>
        <copy todir="${dist.ug.dir}" flatten="true">
            <fileset dir="${projects.dir}">
                <include name="*/docs/ug/build/*.pdf"/>
            </fileset>
        </copy>
        <zip destfile="${docs.zip.filename}">
            <zipfileset dir="${projects.dir}/Indus/docs/javadocs/" prefix="Indus/Indus/docs/javadocs"/>
            <zipfileset dir="${projects.dir}/StaticAnalyses/docs/javadocs/" prefix="Indus/StaticAnalyses/docs/javadocs"/>
            <zipfileset dir="${projects.dir}/JavaSlicer/docs/javadocs/" prefix="Indus/JavaSlicer/docs/javadocs"/>
            <zipfileset dir="${dist.ug.dir}" prefix="Indus/ug"/>
        </zip>
        <delete dir="${dist.ug.dir}"/>

        <copy todir="${dist.dir}" flatten="true">
            <fileset dir="${projects.dir}">
                <include name="*/*.jar"/>
                <exclude name="*/*src*.jar"/>
            </fileset>
        </copy>

        <move todir="${dist.dir}">
            <fileset dir="${dist.dir}">
                <include name="*.jar"/>
            </fileset>
            <mapper type="regexp" from="^([A-Za-z_-]*).jar$$" to="\1-${DSTAMP}.jar"/>
        </move>

        <zip destfile="${examples.src.zip.filename}">
            <fileset dir="${projects.dir}">
                <include name="*/src-xml/**/*CLI.java"/>
            	<include name="Indus/src/**/SootBasedDriver.java"/>
            	<include name="*/src/**/*.xsd"/>
            </fileset>
        </zip>
    </target>

    <target name="cleanAll" depends="init">
        <subant target="clean">
        	<property file="localbuild.properties"/>
            <buildpath refid="subprojects.buildfiles"/>
        </subant>
    </target>

    <target name="buildAllCode" depends="init">
        <subant target="build">
	    	<property file="localbuild.properties"/>
            <buildpath refid="subprojects.buildfiles"/>
        </subant>
        <subant target="jar">
           	<property file="localbuild.properties"/>
            <buildpath refid="subprojects.buildfiles"/>
        </subant>
    </target>

    <target name="buildAllDoc" depends="init">
        <subant target="docs" inheritAll="false" inheritRefs="true">
           	<property file="localbuild.properties"/>            	
            <buildpath refid="subprojects.buildfiles"/>
        </subant>
    </target>

</project>
